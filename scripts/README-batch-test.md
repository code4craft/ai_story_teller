# 批量音色测试脚本

## 功能说明

这个脚本会自动获取系统中的所有音色，并逐个进行测试，生成样本音频并保存到数据库。

## 使用方法

### 1. 确保服务正在运行

在运行脚本前，请确保后端服务器正在运行：

```bash
# 在backend目录
cd ../backend
npm run dev
```

### 2. 运行批量测试脚本

```bash
# 在scripts目录
cd scripts
npm run batch-test
```

或者直接运行：

```bash
node batch-test-voices.js
```

## 脚本特性

### 🎯 核心功能
- 自动获取所有音色列表
- 逐个测试音色并生成样本音频
- 自动保存样本到数据库和文件系统
- 实时显示测试进度

### 🔧 可靠性保障
- **重试机制**：每个音色失败后自动重试3次
- **错误处理**：详细的错误日志和异常处理
- **服务器检查**：运行前检查后端服务器连接状态
- **优雅中断**：支持Ctrl+C安全退出

### 📊 进度跟踪
- 实时显示当前进度 (x/总数)
- 详细的日志输出（成功/失败/警告）
- 自动生成测试报告文件
- 显示总耗时和统计信息

### ⚙️ 配置参数

脚本中的主要配置（可根据需要修改）：

```javascript
const config = {
  baseUrl: 'http://localhost:3001',           // 后端服务器地址
  testText: '你好，这是音色测试，用于生成样本音频。', // 测试文本
  timeout: 60000,                             // 请求超时时间(60秒)
  retryCount: 3,                              // 重试次数
  retryDelay: 2000                            // 重试延迟(2秒)
};
```

## 输出示例

```
🎵 AI故事讲述器 - 批量音色测试脚本
==================================================
[INFO] 2025-01-19T10:30:00.000Z 检查服务器连接...
[SUCCESS] 2025-01-19T10:30:00.100Z 服务器连接正常
[INFO] 2025-01-19T10:30:00.200Z 正在获取音色列表...
[INFO] 2025-01-19T10:30:00.300Z 成功获取 25 个音色
[INFO] 2025-01-19T10:30:00.400Z 开始批量测试音色...
[INFO] 2025-01-19T10:30:00.500Z 进度: 1/25
[INFO] 2025-01-19T10:30:00.600Z 正在测试音色: 东方豪然 (zh_male_dongfanghaoran_moon_bigtts)
[SUCCESS] 2025-01-19T10:30:02.100Z 音色 东方豪然 测试成功，样本已保存
[INFO] 2025-01-19T10:30:03.200Z 进度: 2/25
...
==================================================
[INFO] 2025-01-19T10:35:00.000Z 批量测试完成！
[INFO] 2025-01-19T10:35:00.000Z 总耗时: 300秒
[INFO] 2025-01-19T10:35:00.000Z 总音色数: 25
[SUCCESS] 2025-01-19T10:35:00.000Z 成功: 23
[ERROR] 2025-01-19T10:35:00.000Z 失败: 2
==================================================
[INFO] 2025-01-19T10:35:00.000Z 详细报告已保存到: voice-test-report-2025-01-19T10-35-00.json
```

## 测试报告

脚本执行完成后会自动生成JSON格式的详细报告，包含：

- 测试开始和结束时间
- 每个音色的测试结果
- 成功/失败统计
- 失败音色的错误信息
- 总耗时

## 注意事项

1. **网络稳定性**：确保网络连接稳定，TTS服务需要调用外部API
2. **磁盘空间**：每个音色样本约占用50KB，确保有足够存储空间
3. **执行时间**：根据音色数量，完整测试可能需要几分钟到十几分钟
4. **并发限制**：脚本采用串行执行，避免对TTS服务造成压力
5. **中断恢复**：如果中途中断，重新运行脚本会跳过已有样本的音色

## 故障排除

### 连接失败
```
[ERROR] 无法连接到服务器 http://localhost:3001
```
**解决方案**：确保后端服务器在3001端口正常运行

### TTS服务错误
```
[ERROR] 音色 XXX 测试失败: TTS API错误
```
**解决方案**：检查TTS服务配置和网络连接

### 权限错误
```
[ERROR] 无法写入文件
```
**解决方案**：确保scripts目录有写入权限